MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 1


   1              	;****************************************************************************
   2              	; Copyright 2015, Jacques Deschênes
   3              	; This file is part of ForthEx.
   4              	;
   5              	;     ForthEx is free software: you can redistribute it and/or modify
   6              	;     it under the terms of the GNU General Public License as published by
   7              	;     the Free Software Foundation, either version 3 of the License, or
   8              	;     (at your option) any later version.
   9              	;
  10              	;     ForthEx is distributed in the hope that it will be useful,
  11              	;     but WITHOUT ANY WARRANTY; without even the implied warranty of
  12              	;     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  13              	;     GNU General Public License for more details.
  14              	;
  15              	;     You should have received a copy of the GNU General Public License
  16              	;     along with ForthEx.  If not, see <http://www.gnu.org/licenses/>.
  17              	;
  18              	;****************************************************************************
  19              	;
  20              	; Fichier: keyboard.s
  21              	; Description: transcription code clavier PS/2 en ASCII
  22              	; Auteur: Jacques Deschênes
  23              	; Date: 2015-09-28
  24              	;
  25              	
  26              	.include "hardware.inc"    
   1              	;****************************************************************************
   2              	; Copyright 2015, Jacques Deschênes
   3              	; This file is part of ForthEx.
   4              	;
   5              	;     ForthEx is free software: you can redistribute it and/or modify
   6              	;     it under the terms of the GNU General Public License as published by
   7              	;     the Free Software Foundation, either version 3 of the License, or
   8              	;     (at your option) any later version.
   9              	;
  10              	;     ForthEx is distributed in the hope that it will be useful,
  11              	;     but WITHOUT ANY WARRANTY; without even the implied warranty of
  12              	;     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  13              	;     GNU General Public License for more details.
  14              	;
  15              	;     You should have received a copy of the GNU General Public License
  16              	;     along with ForthEx.  If not, see <http://www.gnu.org/licenses/>.
  17              	;
  18              	;****************************************************************************
  19              	.ifndef HARD_INC
  20              	.equ HARD_INC, 1
  21              	    
  22              	.include "p24Fxxxx.inc"
   1              	.ifdef __24F04KA200
   2              	.include "p24F04KA200.inc"
   3              	.equ VALID_ID,1
   4              	.endif
   5              	
   6              	.ifdef __24F04KA201
   7              	.include "p24F04KA201.inc"
   8              	.equ VALID_ID,1
   9              	.endif
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 2


  10              	
  11              	.ifdef __24F04KL100
  12              	.include "p24F04KL100.inc"
  13              	.equ VALID_ID,1
  14              	.endif
  15              	
  16              	.ifdef __24F04KL101
  17              	.include "p24F04KL101.inc"
  18              	.equ VALID_ID,1
  19              	.endif
  20              	
  21              	.ifdef __24F08KA101
  22              	.include "p24F08KA101.inc"
  23              	.equ VALID_ID,1
  24              	.endif
  25              	
  26              	.ifdef __24F08KA102
  27              	.include "p24F08KA102.inc"
  28              	.equ VALID_ID,1
  29              	.endif
  30              	
  31              	.ifdef __24F08KL200
  32              	.include "p24F08KL200.inc"
  33              	.equ VALID_ID,1
  34              	.endif
  35              	
  36              	.ifdef __24F08KL201
  37              	.include "p24F08KL201.inc"
  38              	.equ VALID_ID,1
  39              	.endif
  40              	
  41              	.ifdef __24F08KL301
  42              	.include "p24F08KL301.inc"
  43              	.equ VALID_ID,1
  44              	.endif
  45              	
  46              	.ifdef __24F08KL302
  47              	.include "p24F08KL302.inc"
  48              	.equ VALID_ID,1
  49              	.endif
  50              	
  51              	.ifdef __24F08KL401
  52              	.include "p24F08KL401.inc"
  53              	.equ VALID_ID,1
  54              	.endif
  55              	
  56              	.ifdef __24F08KL402
  57              	.include "p24F08KL402.inc"
  58              	.equ VALID_ID,1
  59              	.endif
  60              	
  61              	.ifdef __24F08KM101
  62              	.include "p24F08KM101.inc"
  63              	.equ VALID_ID,1
  64              	.endif
  65              	
  66              	.ifdef __24F08KM102
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 3


  67              	.include "p24F08KM102.inc"
  68              	.equ VALID_ID,1
  69              	.endif
  70              	
  71              	.ifdef __24F08KM202
  72              	.include "p24F08KM202.inc"
  73              	.equ VALID_ID,1
  74              	.endif
  75              	
  76              	.ifdef __24F08KM204
  77              	.include "p24F08KM204.inc"
  78              	.equ VALID_ID,1
  79              	.endif
  80              	
  81              	.ifdef __24F16KA101
  82              	.include "p24F16KA101.inc"
  83              	.equ VALID_ID,1
  84              	.endif
  85              	
  86              	.ifdef __24F16KA102
  87              	.include "p24F16KA102.inc"
  88              	.equ VALID_ID,1
  89              	.endif
  90              	
  91              	.ifdef __24F16KA301
  92              	.include "p24F16KA301.inc"
  93              	.equ VALID_ID,1
  94              	.endif
  95              	
  96              	.ifdef __24F16KA302
  97              	.include "p24F16KA302.inc"
  98              	.equ VALID_ID,1
  99              	.endif
 100              	
 101              	.ifdef __24F16KA304
 102              	.include "p24F16KA304.inc"
 103              	.equ VALID_ID,1
 104              	.endif
 105              	
 106              	.ifdef __24F16KL401
 107              	.include "p24F16KL401.inc"
 108              	.equ VALID_ID,1
 109              	.endif
 110              	
 111              	.ifdef __24F16KL402
 112              	.include "p24F16KL402.inc"
 113              	.equ VALID_ID,1
 114              	.endif
 115              	
 116              	.ifdef __24F16KM102
 117              	.include "p24F16KM102.inc"
 118              	.equ VALID_ID,1
 119              	.endif
 120              	
 121              	.ifdef __24F16KM104
 122              	.include "p24F16KM104.inc"
 123              	.equ VALID_ID,1
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 4


 124              	.endif
 125              	
 126              	.ifdef __24F16KM202
 127              	.include "p24F16KM202.inc"
 128              	.equ VALID_ID,1
 129              	.endif
 130              	
 131              	.ifdef __24F16KM204
 132              	.include "p24F16KM204.inc"
 133              	.equ VALID_ID,1
 134              	.endif
 135              	
 136              	.ifdef __24F32KA301
 137              	.include "p24F32KA301.inc"
 138              	.equ VALID_ID,1
 139              	.endif
 140              	
 141              	.ifdef __24F32KA302
 142              	.include "p24F32KA302.inc"
 143              	.equ VALID_ID,1
 144              	.endif
 145              	
 146              	.ifdef __24F32KA304
 147              	.include "p24F32KA304.inc"
 148              	.equ VALID_ID,1
 149              	.endif
 150              	
 151              	.ifdef __24FJ1024GA606
 152              	.include "p24FJ1024GA606.inc"
 153              	.equ VALID_ID,1
 154              	.endif
 155              	
 156              	.ifdef __24FJ1024GA610
 157              	.include "p24FJ1024GA610.inc"
 158              	.equ VALID_ID,1
 159              	.endif
 160              	
 161              	.ifdef __24FJ1024GB606
 162              	.include "p24FJ1024GB606.inc"
 163              	.equ VALID_ID,1
 164              	.endif
 165              	
 166              	.ifdef __24FJ1024GB610
 167              	.include "p24FJ1024GB610.inc"
 168              	.equ VALID_ID,1
 169              	.endif
 170              	
 171              	.ifdef __24FJ128DA106
 172              	.include "p24FJ128DA106.inc"
 173              	.equ VALID_ID,1
 174              	.endif
 175              	
 176              	.ifdef __24FJ128DA110
 177              	.include "p24FJ128DA110.inc"
 178              	.equ VALID_ID,1
 179              	.endif
 180              	
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 5


 181              	.ifdef __24FJ128DA206
 182              	.include "p24FJ128DA206.inc"
 183              	.equ VALID_ID,1
 184              	.endif
 185              	
 186              	.ifdef __24FJ128DA210
 187              	.include "p24FJ128DA210.inc"
 188              	.equ VALID_ID,1
 189              	.endif
 190              	
 191              	.ifdef __24FJ128GA006
 192              	.include "p24FJ128GA006.inc"
 193              	.equ VALID_ID,1
 194              	.endif
 195              	
 196              	.ifdef __24FJ128GA008
 197              	.include "p24FJ128GA008.inc"
 198              	.equ VALID_ID,1
 199              	.endif
 200              	
 201              	.ifdef __24FJ128GA010
 202              	.include "p24FJ128GA010.inc"
 203              	.equ VALID_ID,1
 204              	.endif
 205              	
 206              	.ifdef __24FJ128GA106
 207              	.include "p24FJ128GA106.inc"
 208              	.equ VALID_ID,1
 209              	.endif
 210              	
 211              	.ifdef __24FJ128GA108
 212              	.include "p24FJ128GA108.inc"
 213              	.equ VALID_ID,1
 214              	.endif
 215              	
 216              	.ifdef __24FJ128GA110
 217              	.include "p24FJ128GA110.inc"
 218              	.equ VALID_ID,1
 219              	.endif
 220              	
 221              	.ifdef __24FJ128GA202
 222              	.include "p24FJ128GA202.inc"
 223              	.equ VALID_ID,1
 224              	.endif
 225              	
 226              	.ifdef __24FJ128GA204
 227              	.include "p24FJ128GA204.inc"
 228              	.equ VALID_ID,1
 229              	.endif
 230              	
 231              	.ifdef __24FJ128GA306
 232              	.include "p24FJ128GA306.inc"
 233              	.equ VALID_ID,1
 234              	.endif
 235              	
 236              	.ifdef __24FJ128GA308
 237              	.include "p24FJ128GA308.inc"
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 6


 238              	.equ VALID_ID,1
 239              	.endif
 240              	
 241              	.ifdef __24FJ128GA310
 242              	.include "p24FJ128GA310.inc"
 243              	.equ VALID_ID,1
 244              	.endif
 245              	
 246              	.ifdef __24FJ128GA406
 247              	.include "p24FJ128GA406.inc"
 248              	.equ VALID_ID,1
 249              	.endif
 250              	
 251              	.ifdef __24FJ128GA410
 252              	.include "p24FJ128GA410.inc"
 253              	.equ VALID_ID,1
 254              	.endif
 255              	
 256              	.ifdef __24FJ128GA412
 257              	.include "p24FJ128GA412.inc"
 258              	.equ VALID_ID,1
 259              	.endif
 260              	
 261              	.ifdef __24FJ128GA606
 262              	.include "p24FJ128GA606.inc"
 263              	.equ VALID_ID,1
 264              	.endif
 265              	
 266              	.ifdef __24FJ128GA610
 267              	.include "p24FJ128GA610.inc"
 268              	.equ VALID_ID,1
 269              	.endif
 270              	
 271              	.ifdef __24FJ128GB106
 272              	.include "p24FJ128GB106.inc"
 273              	.equ VALID_ID,1
 274              	.endif
 275              	
 276              	.ifdef __24FJ128GB108
 277              	.include "p24FJ128GB108.inc"
 278              	.equ VALID_ID,1
 279              	.endif
 280              	
 281              	.ifdef __24FJ128GB110
 282              	.include "p24FJ128GB110.inc"
 283              	.equ VALID_ID,1
 284              	.endif
 285              	
 286              	.ifdef __24FJ128GB202
 287              	.include "p24FJ128GB202.inc"
 288              	.equ VALID_ID,1
 289              	.endif
 290              	
 291              	.ifdef __24FJ128GB204
 292              	.include "p24FJ128GB204.inc"
 293              	.equ VALID_ID,1
 294              	.endif
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 7


 295              	
 296              	.ifdef __24FJ128GB206
 297              	.include "p24FJ128GB206.inc"
 298              	.equ VALID_ID,1
 299              	.endif
 300              	
 301              	.ifdef __24FJ128GB210
 302              	.include "p24FJ128GB210.inc"
 303              	.equ VALID_ID,1
 304              	.endif
 305              	
 306              	.ifdef __24FJ128GB406
 307              	.include "p24FJ128GB406.inc"
 308              	.equ VALID_ID,1
 309              	.endif
 310              	
 311              	.ifdef __24FJ128GB410
 312              	.include "p24FJ128GB410.inc"
 313              	.equ VALID_ID,1
 314              	.endif
 315              	
 316              	.ifdef __24FJ128GB412
 317              	.include "p24FJ128GB412.inc"
 318              	.equ VALID_ID,1
 319              	.endif
 320              	
 321              	.ifdef __24FJ128GB606
 322              	.include "p24FJ128GB606.inc"
 323              	.equ VALID_ID,1
 324              	.endif
 325              	
 326              	.ifdef __24FJ128GB610
 327              	.include "p24FJ128GB610.inc"
 328              	.equ VALID_ID,1
 329              	.endif
 330              	
 331              	.ifdef __24FJ128GC006
 332              	.include "p24FJ128GC006.inc"
 333              	.equ VALID_ID,1
 334              	.endif
 335              	
 336              	.ifdef __24FJ128GC010
 337              	.include "p24FJ128GC010.inc"
 338              	.equ VALID_ID,1
 339              	.endif
 340              	
 341              	.ifdef __24FJ16GA002
 342              	.include "p24FJ16GA002.inc"
 343              	.equ VALID_ID,1
 344              	.endif
 345              	
 346              	.ifdef __24FJ16GA004
 347              	.include "p24FJ16GA004.inc"
 348              	.equ VALID_ID,1
 349              	.endif
 350              	
 351              	.ifdef __24FJ16MC101
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 8


 352              	.include "p24FJ16MC101.inc"
 353              	.equ VALID_ID,1
 354              	.endif
 355              	
 356              	.ifdef __24FJ16MC102
 357              	.include "p24FJ16MC102.inc"
 358              	.equ VALID_ID,1
 359              	.endif
 360              	
 361              	.ifdef __24FJ192GA106
 362              	.include "p24FJ192GA106.inc"
 363              	.equ VALID_ID,1
 364              	.endif
 365              	
 366              	.ifdef __24FJ192GA108
 367              	.include "p24FJ192GA108.inc"
 368              	.equ VALID_ID,1
 369              	.endif
 370              	
 371              	.ifdef __24FJ192GA110
 372              	.include "p24FJ192GA110.inc"
 373              	.equ VALID_ID,1
 374              	.endif
 375              	
 376              	.ifdef __24FJ192GB106
 377              	.include "p24FJ192GB106.inc"
 378              	.equ VALID_ID,1
 379              	.endif
 380              	
 381              	.ifdef __24FJ192GB108
 382              	.include "p24FJ192GB108.inc"
 383              	.equ VALID_ID,1
 384              	.endif
 385              	
 386              	.ifdef __24FJ192GB110
 387              	.include "p24FJ192GB110.inc"
 388              	.equ VALID_ID,1
 389              	.endif
 390              	
 391              	.ifdef __24FJ256DA106
 392              	.include "p24FJ256DA106.inc"
 393              	.equ VALID_ID,1
 394              	.endif
 395              	
 396              	.ifdef __24FJ256DA110
 397              	.include "p24FJ256DA110.inc"
 398              	.equ VALID_ID,1
 399              	.endif
 400              	
 401              	.ifdef __24FJ256DA206
 402              	.include "p24FJ256DA206.inc"
 403              	.equ VALID_ID,1
 404              	.endif
 405              	
 406              	.ifdef __24FJ256DA210
 407              	.include "p24FJ256DA210.inc"
 408              	.equ VALID_ID,1
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 9


 409              	.endif
 410              	
 411              	.ifdef __24FJ256GA106
 412              	.include "p24FJ256GA106.inc"
 413              	.equ VALID_ID,1
 414              	.endif
 415              	
 416              	.ifdef __24FJ256GA108
 417              	.include "p24FJ256GA108.inc"
 418              	.equ VALID_ID,1
 419              	.endif
 420              	
 421              	.ifdef __24FJ256GA110
 422              	.include "p24FJ256GA110.inc"
 423              	.equ VALID_ID,1
 424              	.endif
 425              	
 426              	.ifdef __24FJ256GA406
 427              	.include "p24FJ256GA406.inc"
 428              	.equ VALID_ID,1
 429              	.endif
 430              	
 431              	.ifdef __24FJ256GA410
 432              	.include "p24FJ256GA410.inc"
 433              	.equ VALID_ID,1
 434              	.endif
 435              	
 436              	.ifdef __24FJ256GA412
 437              	.include "p24FJ256GA412.inc"
 438              	.equ VALID_ID,1
 439              	.endif
 440              	
 441              	.ifdef __24FJ256GA606
 442              	.include "p24FJ256GA606.inc"
 443              	.equ VALID_ID,1
 444              	.endif
 445              	
 446              	.ifdef __24FJ256GA610
 447              	.include "p24FJ256GA610.inc"
 448              	.equ VALID_ID,1
 449              	.endif
 450              	
 451              	.ifdef __24FJ256GB106
 452              	.include "p24FJ256GB106.inc"
 453              	.equ VALID_ID,1
 454              	.endif
 455              	
 456              	.ifdef __24FJ256GB108
 457              	.include "p24FJ256GB108.inc"
 458              	.equ VALID_ID,1
 459              	.endif
 460              	
 461              	.ifdef __24FJ256GB110
 462              	.include "p24FJ256GB110.inc"
 463              	.equ VALID_ID,1
 464              	.endif
 465              	
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 10


 466              	.ifdef __24FJ256GB206
 467              	.include "p24FJ256GB206.inc"
 468              	.equ VALID_ID,1
 469              	.endif
 470              	
 471              	.ifdef __24FJ256GB210
 472              	.include "p24FJ256GB210.inc"
 473              	.equ VALID_ID,1
 474              	.endif
 475              	
 476              	.ifdef __24FJ256GB406
 477              	.include "p24FJ256GB406.inc"
 478              	.equ VALID_ID,1
 479              	.endif
 480              	
 481              	.ifdef __24FJ256GB410
 482              	.include "p24FJ256GB410.inc"
 483              	.equ VALID_ID,1
 484              	.endif
 485              	
 486              	.ifdef __24FJ256GB412
 487              	.include "p24FJ256GB412.inc"
 488              	.equ VALID_ID,1
 489              	.endif
 490              	
 491              	.ifdef __24FJ256GB606
 492              	.include "p24FJ256GB606.inc"
 493              	.equ VALID_ID,1
 494              	.endif
 495              	
 496              	.ifdef __24FJ256GB610
 497              	.include "p24FJ256GB610.inc"
 498              	.equ VALID_ID,1
 499              	.endif
 500              	
 501              	.ifdef __24FJ32GA002
 502              	.include "p24FJ32GA002.inc"
 503              	.equ VALID_ID,1
 504              	.endif
 505              	
 506              	.ifdef __24FJ32GA004
 507              	.include "p24FJ32GA004.inc"
 508              	.equ VALID_ID,1
 509              	.endif
 510              	
 511              	.ifdef __24FJ32GA102
 512              	.include "p24FJ32GA102.inc"
 513              	.equ VALID_ID,1
 514              	.endif
 515              	
 516              	.ifdef __24FJ32GA104
 517              	.include "p24FJ32GA104.inc"
 518              	.equ VALID_ID,1
 519              	.endif
 520              	
 521              	.ifdef __24FJ32GB002
 522              	.include "p24FJ32GB002.inc"
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 11


 523              	.equ VALID_ID,1
 524              	.endif
 525              	
 526              	.ifdef __24FJ32GB004
 527              	.include "p24FJ32GB004.inc"
 528              	.equ VALID_ID,1
 529              	.endif
 530              	
 531              	.ifdef __24FJ32MC101
 532              	.include "p24FJ32MC101.inc"
 533              	.equ VALID_ID,1
 534              	.endif
 535              	
 536              	.ifdef __24FJ32MC102
 537              	.include "p24FJ32MC102.inc"
 538              	.equ VALID_ID,1
 539              	.endif
 540              	
 541              	.ifdef __24FJ32MC104
 542              	.include "p24FJ32MC104.inc"
 543              	.equ VALID_ID,1
 544              	.endif
 545              	
 546              	.ifdef __24FJ48GA002
 547              	.include "p24FJ48GA002.inc"
 548              	.equ VALID_ID,1
 549              	.endif
 550              	
 551              	.ifdef __24FJ48GA004
 552              	.include "p24FJ48GA004.inc"
 553              	.equ VALID_ID,1
 554              	.endif
 555              	
 556              	.ifdef __24FJ512GA606
 557              	.include "p24FJ512GA606.inc"
 558              	.equ VALID_ID,1
 559              	.endif
 560              	
 561              	.ifdef __24FJ512GA610
 562              	.include "p24FJ512GA610.inc"
 563              	.equ VALID_ID,1
 564              	.endif
 565              	
 566              	.ifdef __24FJ512GB606
 567              	.include "p24FJ512GB606.inc"
 568              	.equ VALID_ID,1
 569              	.endif
 570              	
 571              	.ifdef __24FJ512GB610
 572              	.include "p24FJ512GB610.inc"
 573              	.equ VALID_ID,1
 574              	.endif
 575              	
 576              	.ifdef __24FJ64GA002
 577              	.include "p24FJ64GA002.inc"
   1              	;==========================================================================
   2              	;  PIC24FJ64GA002 Standard Assembly Include File
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 12


   3              	; 
   4              	;  (c) Copyright 2014 Microchip Technology, All rights reserved
   5              	;  Part support version v1.23.A(26-Sep-2014)
   6              	;==========================================================================
   7              	
 2675              	.LIST
 578              	.equ VALID_ID,1
 579              	.endif
 580              	
 581              	.ifdef __24FJ64GA004
 582              	.include "p24FJ64GA004.inc"
 583              	.equ VALID_ID,1
 584              	.endif
 585              	
 586              	.ifdef __24FJ64GA006
 587              	.include "p24FJ64GA006.inc"
 588              	.equ VALID_ID,1
 589              	.endif
 590              	
 591              	.ifdef __24FJ64GA008
 592              	.include "p24FJ64GA008.inc"
 593              	.equ VALID_ID,1
 594              	.endif
 595              	
 596              	.ifdef __24FJ64GA010
 597              	.include "p24FJ64GA010.inc"
 598              	.equ VALID_ID,1
 599              	.endif
 600              	
 601              	.ifdef __24FJ64GA102
 602              	.include "p24FJ64GA102.inc"
 603              	.equ VALID_ID,1
 604              	.endif
 605              	
 606              	.ifdef __24FJ64GA104
 607              	.include "p24FJ64GA104.inc"
 608              	.equ VALID_ID,1
 609              	.endif
 610              	
 611              	.ifdef __24FJ64GA106
 612              	.include "p24FJ64GA106.inc"
 613              	.equ VALID_ID,1
 614              	.endif
 615              	
 616              	.ifdef __24FJ64GA108
 617              	.include "p24FJ64GA108.inc"
 618              	.equ VALID_ID,1
 619              	.endif
 620              	
 621              	.ifdef __24FJ64GA110
 622              	.include "p24FJ64GA110.inc"
 623              	.equ VALID_ID,1
 624              	.endif
 625              	
 626              	.ifdef __24FJ64GA202
 627              	.include "p24FJ64GA202.inc"
 628              	.equ VALID_ID,1
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 13


 629              	.endif
 630              	
 631              	.ifdef __24FJ64GA204
 632              	.include "p24FJ64GA204.inc"
 633              	.equ VALID_ID,1
 634              	.endif
 635              	
 636              	.ifdef __24FJ64GA306
 637              	.include "p24FJ64GA306.inc"
 638              	.equ VALID_ID,1
 639              	.endif
 640              	
 641              	.ifdef __24FJ64GA308
 642              	.include "p24FJ64GA308.inc"
 643              	.equ VALID_ID,1
 644              	.endif
 645              	
 646              	.ifdef __24FJ64GA310
 647              	.include "p24FJ64GA310.inc"
 648              	.equ VALID_ID,1
 649              	.endif
 650              	
 651              	.ifdef __24FJ64GA406
 652              	.include "p24FJ64GA406.inc"
 653              	.equ VALID_ID,1
 654              	.endif
 655              	
 656              	.ifdef __24FJ64GA410
 657              	.include "p24FJ64GA410.inc"
 658              	.equ VALID_ID,1
 659              	.endif
 660              	
 661              	.ifdef __24FJ64GA412
 662              	.include "p24FJ64GA412.inc"
 663              	.equ VALID_ID,1
 664              	.endif
 665              	
 666              	.ifdef __24FJ64GB002
 667              	.include "p24FJ64GB002.inc"
 668              	.equ VALID_ID,1
 669              	.endif
 670              	
 671              	.ifdef __24FJ64GB004
 672              	.include "p24FJ64GB004.inc"
 673              	.equ VALID_ID,1
 674              	.endif
 675              	
 676              	.ifdef __24FJ64GB106
 677              	.include "p24FJ64GB106.inc"
 678              	.equ VALID_ID,1
 679              	.endif
 680              	
 681              	.ifdef __24FJ64GB108
 682              	.include "p24FJ64GB108.inc"
 683              	.equ VALID_ID,1
 684              	.endif
 685              	
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 14


 686              	.ifdef __24FJ64GB110
 687              	.include "p24FJ64GB110.inc"
 688              	.equ VALID_ID,1
 689              	.endif
 690              	
 691              	.ifdef __24FJ64GB202
 692              	.include "p24FJ64GB202.inc"
 693              	.equ VALID_ID,1
 694              	.endif
 695              	
 696              	.ifdef __24FJ64GB204
 697              	.include "p24FJ64GB204.inc"
 698              	.equ VALID_ID,1
 699              	.endif
 700              	
 701              	.ifdef __24FJ64GB406
 702              	.include "p24FJ64GB406.inc"
 703              	.equ VALID_ID,1
 704              	.endif
 705              	
 706              	.ifdef __24FJ64GB410
 707              	.include "p24FJ64GB410.inc"
 708              	.equ VALID_ID,1
 709              	.endif
 710              	
 711              	.ifdef __24FJ64GB412
 712              	.include "p24FJ64GB412.inc"
 713              	.equ VALID_ID,1
 714              	.endif
 715              	
 716              	.ifdef __24FJ64GC006
 717              	.include "p24FJ64GC006.inc"
 718              	.equ VALID_ID,1
 719              	.endif
 720              	
 721              	.ifdef __24FJ64GC010
 722              	.include "p24FJ64GC010.inc"
 723              	.equ VALID_ID,1
 724              	.endif
 725              	
 726              	.ifdef __24FJ96GA006
 727              	.include "p24FJ96GA006.inc"
 728              	.equ VALID_ID,1
 729              	.endif
 730              	
 731              	.ifdef __24FJ96GA008
 732              	.include "p24FJ96GA008.inc"
 733              	.equ VALID_ID,1
 734              	.endif
 735              	
 736              	.ifdef __24FJ96GA010
 737              	.include "p24FJ96GA010.inc"
 738              	.equ VALID_ID,1
 739              	.endif
 740              	
 741              	.ifdef __24FV08KM101
 742              	.include "p24FV08KM101.inc"
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 15


 743              	.equ VALID_ID,1
 744              	.endif
 745              	
 746              	.ifdef __24FV08KM102
 747              	.include "p24FV08KM102.inc"
 748              	.equ VALID_ID,1
 749              	.endif
 750              	
 751              	.ifdef __24FV08KM202
 752              	.include "p24FV08KM202.inc"
 753              	.equ VALID_ID,1
 754              	.endif
 755              	
 756              	.ifdef __24FV08KM204
 757              	.include "p24FV08KM204.inc"
 758              	.equ VALID_ID,1
 759              	.endif
 760              	
 761              	.ifdef __24FV16KA301
 762              	.include "p24FV16KA301.inc"
 763              	.equ VALID_ID,1
 764              	.endif
 765              	
 766              	.ifdef __24FV16KA302
 767              	.include "p24FV16KA302.inc"
 768              	.equ VALID_ID,1
 769              	.endif
 770              	
 771              	.ifdef __24FV16KA304
 772              	.include "p24FV16KA304.inc"
 773              	.equ VALID_ID,1
 774              	.endif
 775              	
 776              	.ifdef __24FV16KM102
 777              	.include "p24FV16KM102.inc"
 778              	.equ VALID_ID,1
 779              	.endif
 780              	
 781              	.ifdef __24FV16KM104
 782              	.include "p24FV16KM104.inc"
 783              	.equ VALID_ID,1
 784              	.endif
 785              	
 786              	.ifdef __24FV16KM202
 787              	.include "p24FV16KM202.inc"
 788              	.equ VALID_ID,1
 789              	.endif
 790              	
 791              	.ifdef __24FV16KM204
 792              	.include "p24FV16KM204.inc"
 793              	.equ VALID_ID,1
 794              	.endif
 795              	
 796              	.ifdef __24FV32KA301
 797              	.include "p24FV32KA301.inc"
 798              	.equ VALID_ID,1
 799              	.endif
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 16


 800              	
 801              	.ifdef __24FV32KA302
 802              	.include "p24FV32KA302.inc"
 803              	.equ VALID_ID,1
 804              	.endif
 805              	
 806              	.ifdef __24FV32KA304
 807              	.include "p24FV32KA304.inc"
 808              	.equ VALID_ID,1
 809              	.endif
 810              	
 811              	.ifndef VALID_ID
 812              	.error "processor ID not specified in generic include file"
 813              	.endif
  23              	
  87              	.LIST
  88              	.endif
  89              	
  27              	.include "video.inc"
   1              	;****************************************************************************
   2              	; Copyright 2015, Jacques Deschênes
   3              	; This file is part of ForthEx.
   4              	;
   5              	;     ForthEx is free software: you can redistribute it and/or modify
   6              	;     it under the terms of the GNU General Public License as published by
   7              	;     the Free Software Foundation, either version 3 of the License, or
   8              	;     (at your option) any later version.
   9              	;
  10              	;     ForthEx is distributed in the hope that it will be useful,
  11              	;     but WITHOUT ANY WARRANTY; without even the implied warranty of
  12              	;     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  13              	;     GNU General Public License for more details.
  14              	;
  15              	;     You should have received a copy of the GNU General Public License
  16              	;     along with ForthEx.  If not, see <http://www.gnu.org/licenses/>.
  17              	;
  18              	;****************************************************************************
  19              	
  20              	; constantes liées au générateur de caractères
  21              	.ifndef VIDEO_INC
  22              	.equ VIDEO_INC, 1
  23              	    
  24              	.equ CHAR_WIDTH,  (8)
  25              	.equ CHAR_HEIGHT, (8)
  26              	.equ FONT_SIZE, (128)
  27              	; caractères pa ligne    
  28              	.equ CPL, (50)
  29              	; ligne par écran    
  30              	.equ LPS, (24)  
  31              	;résolution d'image
  32              	.equ XRES, (CHAR_WIDTH*CPL)
  33              	.equ YRES, (CHAR_HEIGHT*LPS)
  34              	 ; grandeur du tampon vidéo    
  35              	.equ TV_BUFFER, (CPL*LPS)
  36              	
  37              	.endif
  28              	.include "ps2.inc"
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 17


   1              	;****************************************************************************
   2              	; Copyright 2015, Jacques Deschênes
   3              	; This file is part of ForthEx.
   4              	;
   5              	;     ForthEx is free software: you can redistribute it and/or modify
   6              	;     it under the terms of the GNU General Public License as published by
   7              	;     the Free Software Foundation, either version 3 of the License, or
   8              	;     (at your option) any later version.
   9              	;
  10              	;     ForthEx is distributed in the hope that it will be useful,
  11              	;     but WITHOUT ANY WARRANTY; without even the implied warranty of
  12              	;     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  13              	;     GNU General Public License for more details.
  14              	;
  15              	;     You should have received a copy of the GNU General Public License
  16              	;     along with ForthEx.  If not, see <http://www.gnu.org/licenses/>.
  17              	;
  18              	;****************************************************************************
  19              	
  20              	;NOM: ps2.inc
  21              	;DESCRIPTION: constante reliée au clavier PS/2
  22              	;DATE: 2015-09-28
  23              	;REF: http://www.computer-engineering.org/ps2keyboard/scancodes2.html 
  24              	    
  25              	.ifndef PS2_INC
  26              	.equ PS2_INC, 1
  27              	
  28              	 ;codes touches contrôles
  29              	.equ SC_KREL,  0xF0 ; touche relâchée
  30              	.equ SC_XKEY,  0xE0 ; code étendu
  31              	.equ L_SHIFT,  0x12
  32              	.equ R_SHIFT,  0x59
  33              	.equ L_CTRL,   0x14
  34              	.equ L_ALT,    0x11
  35              	.equ ENTER,    0x5A
  36              	.equ CAPS,     0x58
  37              	.equ SCROLL,   0x7E
  38              	.equ NUM,      0x77
  39              	.equ ESC,      0x76
  40              	.equ F1,       0x05
  41              	.equ F2,       0x06
  42              	.equ F3,       0x04
  43              	.equ F4,       0x0C
  44              	.equ F5,       0x03
  45              	.equ F6,       0x0B
  46              	.equ F7,       0x83 
  47              	.equ F8,       0x0A
  48              	.equ F9,       0x01
  49              	.equ F10,      0x09
  50              	.equ F11,      0x78
  51              	.equ F12,      0x07
  52              	 ; touches clavier numérique
  53              	.equ KP0,      0x70
  54              	.equ KP1,      0x69
  55              	.equ KP2,      0x72
  56              	.equ KP3,      0x7A
  57              	.equ KP4,      0x6B
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 18


  58              	.equ KP5,      0x73
  59              	.equ KP6,      0x74
  60              	.equ KP7,      0x6C
  61              	.equ KP8,      0x75
  62              	.equ KP9,      0x7D
  63              	.equ KPDOT,    0x71
  64              	.equ KPPLUS,   0x79
  65              	.equ KPMINUS,  0x7B
  66              	.equ KPSTAR,   0x7C
  67              	; code étendus (précédé de 0xE0) 
  68              	.equ R_CTRL,   0x14
  69              	.equ L_GUI,    0x1f
  70              	.equ R_GUI,    0x27
  71              	.equ R_ALT,    0x11
  72              	.equ APPS,     0x2f 
  73              	.equ INSERT,   0x70
  74              	.equ HOME,     0x6C
  75              	.equ PGUP,     0x7D
  76              	.equ DEL,      0x71
  77              	.equ END,      0x69
  78              	.equ PGDN,     0x7A
  79              	.equ UP,       0x75
  80              	.equ DOWN,     0x72
  81              	.equ LEFT,     0x6B
  82              	.equ RIGHT,    0x74
  83              	.equ KPSLH,    0x4A
  84              	.equ KPENT,    0x5A 
  85              	 
  86              	;indicateurs booléens dans key_state
  87              	.equ F_SHIFT, 0 ; touche majuscule enfoncée
  88              	.equ F_CTRL, 1  ; touche ctrl enfoncée
  89              	.equ F_ALT, 2   ; touche alt enfoncée
  90              	.equ F_CAPS, 3  ; FixMaj actif
  91              	.equ F_NUM,  4  ; clavier numérique actif
  92              	.equ F_XKEY, 5 ; touche étendue
  93              	.equ F_KREL, 6 ; relâchement touche
  94              	; grandeur file interface PS/2 
  95              	.equ PS2_QUEUE_SIZE, 32
  96              	.endif
  97              	
  29              	.include "keyboard.inc"    
   1              	;****************************************************************************
   2              	; Copyright 2015, Jacques Deschênes
   3              	; This file is part of ForthEx.
   4              	;
   5              	;     ForthEx is free software: you can redistribute it and/or modify
   6              	;     it under the terms of the GNU General Public License as published by
   7              	;     the Free Software Foundation, either version 3 of the License, or
   8              	;     (at your option) any later version.
   9              	;
  10              	;     ForthEx is distributed in the hope that it will be useful,
  11              	;     but WITHOUT ANY WARRANTY; without even the implied warranty of
  12              	;     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  13              	;     GNU General Public License for more details.
  14              	;
  15              	;     You should have received a copy of the GNU General Public License
  16              	;     along with ForthEx.  If not, see <http://www.gnu.org/licenses/>.
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 19


  17              	;
  18              	;****************************************************************************
  19              	;
  20              	; Fichier: keyboard.inc
  21              	; Description: constantes pour les touches retournées par kbd_get
  22              	; Auteur: Jacques Deschênes
  23              	; Date: 2015-10-01
  24              	; Les touches non associées à un caractères ASCII
  25              	; on une valeur inférieure à 32 ou supérieure à 127
  26              	.ifndef KBD_INC
  27              	.equ KBD_INC, 1
  28              	
  29              	; touches qui ne corespondes pas un symbole ASCII    
  30              	;Nom			valeur	    Description
  31              	.equ VK_BACK,		8	    ;	Backspace
  32              	.equ VK_ESCAPE,		27	    ;	Esc
  33              	.equ VK_RETURN,		13	    ; touche Entrée    
  34              	.equ VK_CTRL,           128         ; touche contrôle droite ou gauche
  35              	.equ VK_SHIFT,          129         ; touche maj. droite ou gauche
  36              	.equ VK_ALT,            130         ; touche ALT gauche ou droite
  37              	.equ VK_CAPS,           131         ; touche fix Maj. 
  38              	.equ VK_TAB,		9           ; touche tabulation
  39              	.equ VK_DEL,            132         ; touche Suppr
  40              	.equ VK_INS,		133	    ; touche Inser
  41              	.equ VK_HOME,		134	    ; touche début fichier
  42              	.equ VK_END,		135	    ; touche fin de fichier
  43              	.equ VK_UP,		136	    ; flèche vers le haut
  44              	.equ VK_DOWN,		137	    ; flèvhe vers le bas
  45              	.equ VK_LEFT,		138	    ; flèche vers la gauche
  46              	.equ VK_RIGHT,		139	    ; flèche vers le bas
  47              	.equ VK_PGUP,		140	    ; page vers le haut
  48              	.equ VK_PGDN,		141	    ; page vers le bas
  49              	.equ VK_F1,		150	    ; fonction F1
  50              	.equ VK_F2,		151	    ; fonction F2
  51              	.equ VK_F3,		152	    ; fonction F3
  52              	.equ VK_F4,		153	    ; fonction F4
  53              	.equ VK_F5,		154	    ; fonction F5
  54              	.equ VK_F6,		155	    ; fonction F6
  55              	.equ VK_F7,		156	    ; fonction F7
  56              	.equ VK_F8,		157	    ; fonction F8
  57              	.equ VK_F9,		158	    ; fonction F9
  58              	.equ VK_F10,		159	    ; fonction F10
  59              	.equ VK_F11,		160	    ; fonction F11
  60              	.equ VK_F12,		161	    ; fonction F12    
  61              	
  62              	.endif
  63              	    
  30              	.include "gen_macros.inc"
   1              	;****************************************************************************
   2              	; Copyright 2015, Jacques Deschênes
   3              	; This file is part of ForthEx.
   4              	;
   5              	;     ForthEx is free software: you can redistribute it and/or modify
   6              	;     it under the terms of the GNU General Public License as published by
   7              	;     the Free Software Foundation, either version 3 of the License, or
   8              	;     (at your option) any later version.
   9              	;
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 20


  10              	;     ForthEx is distributed in the hope that it will be useful,
  11              	;     but WITHOUT ANY WARRANTY; without even the implied warranty of
  12              	;     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  13              	;     GNU General Public License for more details.
  14              	;
  15              	;     You should have received a copy of the GNU General Public License
  16              	;     along with ForthEx.  If not, see <http://www.gnu.org/licenses/>.
  17              	;
  18              	;****************************************************************************
  19              	
  20              	;Fichier: gen_macro.inc
  21              	;Description:  définition de macros d'usage général
  22              	;Date: 2015-10-02
  23              	.ifndef GEN_MACCRO
  24              	.equ GEN_MACRO, 1
  25              	
  26              	.macro set_psv table, reg
  27              	    mov #psvpage(\table), \reg
  28              	    mov \reg, PSVPAG
  29              	    mov #psvoffset(\table), \reg
  30              	.endm
  31              	
  32              	.endif
  33              	
  31              	    
  32              	 
  33              	.equ KBD_QUEUE_SIZE, 32    
  34              	 
  35              	.data
  36                 	kbd_queue:
  37 0000 00 00 00 00 	.space KBD_QUEUE_SIZE    
  37      00 00 00 00 
  37      00 00 00 00 
  37      00 00 00 00 
  37      00 00 00 00 
  37      00 00 00 00 
  37      00 00 00 00 
  37      00 00 00 00 
  38                 	kbd_head:
  39 0020 00 00       	.word 0
  40                 	kbd_tail:
  41 0022 00 00       	.word 0
  42                 	key_state:    
  43 0024 00          	.byte 0
  44                 	    
  45 0025 00          	.text
  46              	
  47              	;;;;;;;;;;;;;;;;;;;;;;;
  48              	; retourne le code clavier
  49              	; dans W0 sinon retourne 0
  50              	;;;;;;;;;;;;;;;;;;;;;;;
  51              	.global get_code    
  52              	get_code:
  53 000000  00 00 EB 	    clr W0
  54 000002  01 00 80 	    mov kbd_head, W1
  55 000004  02 00 80 	    mov kbd_tail, W2
  56 000006  02 08 E1 	    cp  W1,W2
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 21


  57 000008  00 00 32 	    bra eq, 1f
  58 00000a  02 00 20 	    mov #kbd_queue,W2
  59 00000c  02 81 40 	    add W1,W2,W2
  60 00000e  20 20 EC 	    inc kbd_head
  61 000010  F0 01 20 	    mov #(KBD_QUEUE_SIZE-1), W0
  62 000012  20 20 B6 	    and kbd_head
  63 000014  12 40 78 	    mov.b [W2], W0
  64 000016  00 80 FB 	    ze W0,W0
  65              	1:
  66 000018  00 00 06 	    return
  67              	
  68              	;;;;;;;;;;;;;;;;;;;;;;;;
  69              	; recherche code clavier
  70              	; dans la table
  71              	; entrée: W2=index table    
  72              	;         W1=scancode recherché
  73              	; sortie: W0 contient caractère
  74              	;         W0=0 si scancode pas dans la table
  75              	; modifie: W0,W2,W3    
  76              	;;;;;;;;;;;;;;;;;;;;;;;;;
  77              	search_table:
  78              	1:
  79 00001a  32 00 78 	    mov [W2++], W0
  80 00001c  00 00 E0 	    cp0 W0
  81 00001e  00 00 32 	    bra eq, 2f
  82 000020  80 01 78 	    mov W0, W3
  83 000022  83 81 FB 	    ze W3,W3
  84 000024  01 18 E1 	    cp W3,W1
  85 000026  00 00 3A 	    bra neq, 1b
  86 000028  00 80 FD 	    swap W0
  87 00002a  00 80 FB 	    ze W0,W0
  88              	2: ; pas trouvé
  89 00002c  00 00 06 	    return
  90              	
  91              	    
  92              	;;;;;;;;;;;;;;;;;;;;;;;
  93              	; retourne un caractère
  94              	; si disponible
  95              	; sortie: W0
  96              	;;;;;;;;;;;;;;;;;;;;;;;    
  97              	.global kbd_get
  98              	
  99              	kbd_get:
 100 00002e  00 00 F8 	    push PSVPAG
 101 000030  00 00 02 	    call get_code
 101         00 00 00 
 102 000034  00 00 E0 	    cp0 W0
 103 000036  00 00 32 	    bra eq, kbd_no_key   
 104              	    ;code clavier touche étendue?
 105 000038  01 0E 20 	    mov #SC_XKEY, W1
 106 00003a  00 08 E1 	    cp W1,W0
 107 00003c  00 00 3A 	    bra neq, 1f
 108 00003e  24 A0 A8 	    bset key_state, #F_XKEY
 109 000040  00 00 02 	    call get_code
 109         00 00 00 
 110 000044  00 00 E0 	    cp0 W0
 111 000046  00 00 32 	    bra eq, kbd_no_key
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 22


 112              	1:
 113              	    ;code clavier relâchement touche?
 114 000048  01 0F 20 	    mov #SC_KREL, W1
 115 00004a  00 08 E1 	    cp W1, W0
 116 00004c  00 00 3A 	    bra neq, 2f
 117 00004e  24 C0 A8 	    bset key_state, #F_KREL
 118 000050  00 00 02 	    call get_code
 118         00 00 00 
 119 000054  00 00 E0 	    cp0 W0
 120 000056  00 00 32 	    bra eq, kbd_no_key
 121              	2:
 122 000058  80 00 78 	    mov W0,W1
 123 00005a  24 A0 AE 	    btss key_state, #F_XKEY
 124 00005c  00 00 37 	    bra try_shifted
 125              	    ; recherche table 'extended'
 126 00005e  02 00 20 	    set_psv extended, W2
 126         02 00 88 
 126         02 00 20 
 127 000064  00 00 02 	    call search_table
 127         00 00 00 
 128 000068  00 00 E0 	    cp0 W0
 129 00006a  00 00 32 	    bra eq, try_shifted
 130              	    ; scancode trouvé dans la table 'extended'
 131 00006c  00 00 37 	    bra exit_goodkey
 132              	try_shifted:  ; recherche table 'shifted'
 133 00006e  24 00 AE 	    btss key_state, #F_SHIFT
 134 000070  00 00 37 	    bra try_ascii
 135 000072  02 00 20 	    set_psv shifted, W2
 135         02 00 88 
 135         02 00 20 
 136 000078  00 00 02 	    call search_table
 136         00 00 00 
 137 00007c  00 00 E0 	    cp0 W0
 138 00007e  00 00 32 	    bra eq, try_ascii
 139              	    ; scancode trouvé dans la table 'shifted'
 140 000080  00 00 37 	    bra exit_goodkey
 141              	try_ascii:  ; recherche table 'ascii'
 142 000082  02 00 20 	    set_psv ascii, W2
 142         02 00 88 
 142         02 00 20 
 143 000088  00 00 02 	    call search_table
 143         00 00 00 
 144 00008c  00 00 E0 	    cp0 W0
 145 00008e  00 00 32 	    bra eq, try_ext_key
 146              	    ; scancode trouvé dans la table 'ascii'
 147 000090  11 06 20 	    mov #'a', W1
 148 000092  01 00 E1 	    cp W0,W1
 149 000094  00 00 39 	    bra ltu, exit_goodkey
 150 000096  A1 07 20 	    mov #'z', W1
 151 000098  01 00 E1 	    cp W0, W1
 152 00009a  00 00 3E 	    bra gtu, exit_goodkey
 153              	    ;lettre
 154 00009c  24 C0 AF 	    btsc key_state, #F_KREL
 155 00009e  00 00 37 	    bra exit_ignore_it
 156 0000a0  24 60 AE 	    btss key_state, #F_CAPS
 157 0000a2  00 50 A2 	    btg  W0, #5 
 158 0000a4  24 00 AF 	    btsc key_state, #F_SHIFT
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 23


 159 0000a6  00 50 A2 	    btg W0, #5
 160 0000a8  00 00 37 	    bra exit_goodkey
 161              	try_ext_key:
 162 0000aa  02 00 20 	    set_psv extended, W2
 162         02 00 88 
 162         02 00 20 
 163 0000b0  00 00 02 	    call search_table
 163         00 00 00 
 164 0000b4  00 00 E0 	    cp0 W0
 165 0000b6  00 00 32 	    bra eq, try_mod_key
 166 0000b8  00 00 37 	    bra exit_goodkey
 167              	try_mod_key:
 168 0000ba  02 00 20 	    set_psv mod, W2
 168         02 00 88 
 168         02 00 20 
 169 0000c0  00 00 02 	    call search_table
 169         00 00 00 
 170 0000c4  00 00 E0 	    cp0 W0
 171 0000c6  00 00 32 	    bra eq, try_xmod_key
 172 0000c8  00 00 37 	    bra mod_switch
 173              	try_xmod_key:
 174 0000ca  02 00 20 	    set_psv xmod, W2
 174         02 00 88 
 174         02 00 20 
 175 0000d0  00 00 02 	    call search_table
 175         00 00 00 
 176 0000d4  00 00 E0 	    cp0 W0
 177 0000d6  00 00 32 	    bra eq, exit_ignore_it
 178              	mod_switch:
 179 0000d8  11 08 20 	    mov #VK_SHIFT, W1
 180 0000da  01 00 E1 	    cp W0,W1
 181 0000dc  00 00 3A 	    bra neq, 6f
 182 0000de  24 00 A9 	    bclr key_state, #F_SHIFT
 183 0000e0  24 C0 AE 	    btss key_state, #F_KREL
 184 0000e2  24 00 A8 	    bset key_state, #F_SHIFT
 185 0000e4  00 00 37 	    bra exit_ignore_it
 186              	6:
 187 0000e6  31 08 20 	    mov #VK_CAPS, W1
 188 0000e8  01 00 E1 	    cp W0,W1
 189 0000ea  00 00 3A 	    bra neq, 7f
 190 0000ec  24 C0 AE 	    btss key_state, #F_KREL
 191 0000ee  24 60 AA 	    btg key_state, #F_CAPS
 192 0000f0  00 00 37 	    bra exit_ignore_it
 193              	7:  
 194 0000f2  01 08 20 	    mov #VK_CTRL, W1
 195 0000f4  01 00 E1 	    cp W0, W1
 196 0000f6  00 00 3A 	    bra neq, 8f
 197 0000f8  24 20 A9 	    bclr key_state, #F_CTRL
 198 0000fa  24 C0 AE 	    btss key_state, #F_KREL
 199 0000fc  24 20 A8 	    bset key_state, #F_CTRL
 200 0000fe  00 00 37 	    bra exit_ignore_it
 201              	8:
 202 000100  21 08 20 	    mov #VK_ALT, W1
 203 000102  01 00 E1 	    cp W0,W1
 204 000104  00 00 3A 	    bra neq, exit_ignore_it
 205 000106  24 40 A9 	    bclr key_state, #F_ALT
 206 000108  24 C0 AE 	    btss key_state, #F_KREL
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 24


 207 00010a  24 20 A8 	    bset key_state, #F_CTRL
 208              	exit_ignore_it:    
 209              	exit_badkey: ;sortie touche refusée
 210 00010c  00 00 EB 	    clr W0
 211              	exit_goodkey:  ; sortie touche acceptée
 212 00010e  24 C0 A9 	    bclr key_state, #F_KREL
 213 000110  24 A0 A9 	    bclr key_state, #F_XKEY
 214              	kbd_no_key: ; sortie file vide
 215 000112  00 00 F9 	    pop PSVPAG
 216 000114  00 00 06 	    return
 217              	    
 218              	;;;;;;;;;;;;;;;;;;;;;;;;;
 219              	; interruption TIMER1
 220              	; incrémente SYSTICK
 221              	; et traitement primaire
 222              	; file ps2_queue vers kbd_queue
 223              	;;;;;;;;;;;;;;;;;;;;;;;;;
 224              	
 225              	.extern systicks
 226              	.extern ps2_head
 227              	.extern ps2_tail    
 228              	.extern ps2_queue  
 229              	    
 230              	.global __T1Interrupt   
 231              	__T1Interrupt:
 232 000116  80 1F 78 	    push W0
 233 000118  81 1F 78 	    push W1
 234 00011a  82 1F 78 	    push W2
 235 00011c  83 1F 78 	    push W3
 236 00011e  00 20 EC 	    inc systicks
 237 000120  00 00 80 	    mov ps2_head, W0
 238 000122  00 00 E3 	    cp ps2_tail
 239 000124  00 00 32 	    bra z, isr_exit
 240 000126  01 00 20 	    mov #ps2_queue, W1
 241 000128  81 00 40 	    add W0, W1, W1
 242 00012a  11 00 78 	    mov [W1], W0
 243 00012c  00 00 D1 	    lsr W0,W0
 244 00012e  00 00 31 	    bra c, 9f ; start bit doit-être zéro
 245 000130  00 90 A3 	    btst.c W0, #9
 246 000132  00 00 39 	    bra nc, 9f ; stop bit doit-être 1
 247 000134  80 01 EB 	    clr W3
 248 000136  F0 1F B2 	    and #0x1ff, W0
 249 000138  02 00 20 	    mov #0, W2
 250              	1:
 251 00013a  00 10 A5 	    btst.c W0,W2
 252 00013c  00 00 39 	    bra nc, 2f
 253 00013e  83 01 E8 	    inc W3,W3
 254              	2:    
 255 000140  02 01 E8 	    inc W2,W2
 256 000142  69 10 E1 	    cp W2, #9
 257 000144  00 00 3A 	    bra neq, 1b
 258              	    ; paritée impaire, W3 doit-être impaire.
 259 000146  03 00 A6 	    btss W3,#0
 260 000148  00 00 37 	    bra 9f
 261 00014a  01 00 20 	    mov #kbd_queue, W1
 262 00014c  02 00 80 	    mov kbd_tail, W2
 263 00014e  81 00 41 	    add W2,W1,W1
MPLAB XC16 ASSEMBLY Listing:  keyboard.s 			page 25


 264 000150  80 48 78 	    mov.b W0,[W1]
 265 000152  12 00 B0 	    add #1,W2
 266 000154  F2 01 B2 	    and #(KBD_QUEUE_SIZE-1),W2
 267 000156  02 00 88 	    mov W2, kbd_tail
 268              	9:    
 269              	    ;incrémente ps2_head
 270 000158  00 A0 EC 	    inc2 ps2_head
 271 00015a  F0 01 20 	    mov #(PS2_QUEUE_SIZE-1), W0
 272 00015c  00 20 B6 	    and ps2_head
 273              	isr_exit:
 274 00015e  CF 01 78 	    pop W3
 275 000160  4F 01 78 	    pop W2
 276 000162  CF 00 78 	    pop W1
 277 000164  4F 00 78 	    pop W0
 278 000166  00 60 A9 	    bclr IFS0, #T1IF
 279 000168  00 40 06 	    retfie
 280              	    
 281              	.end
