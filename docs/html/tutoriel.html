<DOCTYPE! html>
<html lang="fr-CA">
<head>
<style>
p{
	margin-left:5%;
	width:90%;
}
hr{
	margin-left:5%;
	width:90%;
	border-width:4px;
}
div{
	margin-left:5%;
	width:90%;
	padding:5px;
}
textarea#code{
	align:left;
	min-width:40%;
    max-width:60%;
//    margin:auto;
    line-height:1.5;
    border-radius:4px;
    border:1px solid #F7E98D;
    margin:4px;
    font:13px Tahoma, cursive;
    font-smoothing:subpixel-antialiased;
    background-color:#F9EFAF;
    }
</style>
</head>
<body>
<h2>Présentation</h2>
<p>
	Ce tutoriel consiste à décrire toutes les étapes de la création d'un jeux vidéo simple, le classique 
	<a href="https://fr.wikipedia.org/wiki/Snake_(jeu_vid%C3%A9o)">Snake</a>. Il existe plusieurs variantes de ce jeux.
	Comme il s'agit d'un tutoriel sur le langage Forth, cette version sera simple. 

</p>
<h3>règles du jeux</h3>
<p>
	<div><ol>
		<li>Le serpent ne doit pas entrer en collision avec la bordure de l'aire de jeux.</li>
		<li>Le serpent ne doit pas se mordre lui-même.</li>
		<li>Le serpent mange les pastilles qui apparaîssent dans l'aire de jeux.</li>
		<li>Le pointage est compté de la façon suivante:
		<ul>
			<li>1 pastille dans un coin compte pour 4 points.</li>
			<li>1 pastille le long d'un mur compte pour 2 points.</li>
			<li>Les autres pastilles comptent pour 1 point.</li>
		</ul></li>
		<li>Lorsque le serpent mange une pastille il s'allonge d'un anneau.</li>
		<li>Le serpent est toujours en mouvement mais sa direction est contrôlée par les flèches gauche et droite.</li>
	</ol></div>
</p>
<h3>L'aire de jeux</h3>
<p>Le pourtour de l'écran est circonsris par une ligne blanche, le serpent est donc limité à une surface de 62 par 22 pixels. 
   Puisqu'il s'agit d'un écran texte, les pixels ici sont représentés par l'espace d'un caractère. Sur la première ligne de
   l'écran s'affiche le pointage <b>SCORE:</b>, et la longueur du serpent <b>LENGTH:</b>. Ces compteurs augmentent chaque fois qu'il mange.</p>
<h3>Analyse du programme.</h3>   
<p>Essayons de voir de quoi nous avons besoins pour réaliser ce jeux.</p>
<h4>Variables</h4>
<p>
	<div><ul>
		<li><b>SCORE</b>, Cette variable contient le pointage.</li>
		<li><b>SNAKE-LEN</b>, Cette variable indique la longueur du serpent.</li>
		<li><b>SNAKE</b>, Le corps du serpent doit-être représenté par un tableau (vecteur). Chaque élément de ce tableau
		contient les coordonnées de chaque caractère qui consistuent le corps du serpent.</li>
		<li><b>HEAD</b>, Cette variable indique la direction de déplacement de la tête du serpent. Nous voulons que la tête
		du serpent ressemble à une bouche ouverte, nous allons donc utiliser un caractère différent pour chaque direction.
		<table border="single">
			<tr><th>direction</th><th>valeur</th><th>car. tête</th></tr>
			<tr><td>est</td><td>0</td><td>&lt;</td></tr>
			<tr><td>sud</td><td>1</td><td>W</td></tr>
			<tr><td>ouest</td><td>2</td><td>&gt;</td></tr>
			<tr><td>nord</td><td>3</td><td>M</td></tr>
		</table>
		</li>
		<li><b>C-HEAD</b>, Il s'agit d'un tableau de 4 caractères qui va nous permettre d'obtenir le caractère à afficher
		pour la tête en fonction de la direction. On obtiendra le bon caractère en indiçant le tableau avec la valeur de la variable
	    <b>HEAD</b>.</li>
	    <li><b>FOOD</b>, Cette variable contient les coordonnées de la pastille de nourriture. Lorsque la pastille est avalée par le serpent
	    les coordonnées sont remises à {0,0}.</li>
	    <li><b>TAIL</b>, Nous avons besoin de savoir où était le dernier anneau du serpent avant son dernier déplacement.
	    Cette information va nous permettre d'effacer cet anneau après le déplacement ou d'allonger le serpent lorsqu'il mange.</li>
	</ul></div>
</p>   
<p>
	Le corps du serpent et les pastilles de nourritures seront représentés par le caractère <b>O</b>.<br>
	Dans cette version simple du jeux le serpent va toujours se déplacer à la même vitesse. Le délais de boucle sera donc déterminée
	par une constante <b>SPEED</b>.
</p>
<h3>Déroulement du progamme (algorithme)</h3>
<p>
	<div><ol>
		<li>Déclaration des constantes.</li>
		<li>Déclaration des variables.</li>
		<li>Initialisation d'une partie:
		<ul>
			<li>Initialisation des variables.</li>
			<li>Création du serpent initial.</li>
			<li>Dessin des murs.</li>
		</ul>
		</li>
		<li>Boucle de la partie:
		<ol>
			<li>Afficher le status.</li>
			<li>S'il n'y a pas de pastille dans l'aire de jeux en créer une.</li>
			<li>Afficher la pastille.</li>
			<li>Dessin du serpent.</li>
			<li>Mouvement du serpent.</li>
			<li>Si le serpent a avalé la pastille ajuster le pointage et la longueur.</li>
			<li>Sinon vérification collision, si collision terminer partie.</li>
			<li>Délais vitesse déplacement.</li>
			<li>Lire clavier, si touche <i>flèche-gauche</i> ou <i>flèche-droite</i> modifier variable HEAD. Si <b>Q</b> quitter le jeu.</li>
			<li>Boucler à l'étape 1.</li>
		</ol>
		</li>
		<li>Signaler fin de la partie.</li>
		<li>Attendre touche pour intialiser la prochaine partie ou (Q)uitter.</li>
	</ol></div>
</p>  
<h3>Débutons le codage</h3>
<p>
	À ce point çi nous disposons suffisamment d'information pour débuter l'écriture du code. Si nous avons manquer un point nous nous ajusterons en
	cours de route. Mais d'abord il faut répondre à quelques questions.
	<div><ul>
	<li>Quel sera la longueur initiale du serpent?</li>
	<li>Est-ce que le serpent a une position et une direction initiale fixes, où laissons-nous ça au hasard?</li>
	</ul></div>
	<div>
	En Forth il y a 2 types de commentaires, les commentaires qui débutent par le mot <b>\</b> et se termine à la fin de la ligne et les commenataires
	qui débutent par le mot <b>(</b> et se termine par le délimiteur <b>)</b>. J'ai bien dit que <b>\</b> et <b>(</b> étaient des mots Forth donc ils sont
	séparés des autres mots par un espace. exemples:<br>
	<textarea id="code" style="height:100px;">
	\ Ceci est un commentaire qui se termine à la fin de ligne.
	( Ceci est un commentaire qui se termine ici.)
	( Je peu mettre du code après ce commentaire.) 314 CONSTANT 100PI
	\ Je viens de créer une constante qui s'appelle 100PI 
	</textarea></div>
</p>
<p>
	Commençons donc à créer notre programme snake.<br>
	Définissons quelques constantes.<br>
	<textarea id="code" style="height:220px;">
	128 constant max-len \ longueur maximale du serpent.
	\ directions des deplacements
	0 constant east
	1 constant south
	2 constant west
	3 constant north
	62 constant play-width \ largeur aire de jeu
	22 constant play-height \ hauteur aire de jeu
	2 constant x-offset \ décalage coordonnee X dans l'affichage
	2 constant y-offset \ décalage coordonnee Y dans l'affichage
	143 constant vk_left \ code touche fleche gauche
	144 constant vk_right \ code touche fleche droite	
	</textarea><br>
	Et les variables<br>
	<textarea id="code" style="height:120px;">
	\ création des variables, elles sont inialisée à 0 lors de leur création.
	VARIABLE SCORE \ pointage
	VARIABLE SNAKE-LEN \ longueur du serpent.
	VARIABLE HEAD \ Indique la direction de déplacement de la tête du serpent.
	VARIABLE FOOD \ Contient les coordonnées de la pastille de nourriture.
	VARIABLE TAIL \ contient les coordonnées de la queue du serpent.
	</textarea>
</p>
<p>
	Il nous reste encore 2 variables à créer mais ces variables sont de type tableau (quoique je préfère le mot vecteur). Avant de créer ces 2 variables vecteurs
	je vais définir un mot particulier appellé <b>VECTOR</b>. Ce mot est un mot qui sert à créer une classe de mots,de la même manière que le mot 
	<b>VARIABLE</b> nous a permis de créer des objets de type <i>variable</i>, le mot <b>VECTOR</b> va nous permettre de créer des objets de type <i>tableau</i>.
	<br>
	<textarea id="code" style="height:80px;">
		\ VECTOR va nous permettre de créer des tableaux à 1 dimension.
		: VECTOR ( cccc -- )
		  CREATE CELLS ALLOT DOES&gt; SWAP CELLS + ;
    </textarea>
</p> 
<p>
	Comme la définition de <b>VECTOR</b> fait appel à un concept avancé de Forth et que ce tutoriel est une introduction au langage Forth, je ne vous expliquerez
	pas ici le fonctionnement de <b>CREATE</b> et <b>DOES&gt;</b>. Pour le moment ils vous suffit de savoir qu'avec ce nouveau mot nous allons pouvoir créer
	des tableaux à une dimension.
</p>
<p>
	Donc lorsque l'interpréteur à terminé la lecture du code ci-haut on a un nouveau mot dans le dictionnaire, <b>VECTOR</b> et on va s'en servir
	pour créer des variables de type <i>tableau</i>. La définition du mot commence par <b>:</b> et se termine par <b>;</b>. Le mot qui suis <b>:</b> est 
	le nom du mot qu'on ajoute au dictionnaire Forth, en l'occurence il s'agit du mot <b>VECTOR</b>. Nous allons nous servir de vector pour creer les
	variables <b>c-head</b> et <b>snake</b>.<br>
	<textarea id="code" style="height:180px;">
	\ ForthEx ne fait pas de difference entre lettres
	\ minuscules et majuscules.	
	4 vector c-head \ tableau de 4 car. representant la tete du serpent.
	max-len vector snake \ le corps du serpent.
	
	\ initialiation de c-head
	'&lt;' east c-head !
	'W' south c-head !
	'&gt;' west c-head !
	'M' north c-head !
	</textarea>
</p>
<p>
	J'ai pris la décision qu'au départ le serpent est au centre de l'écran qu'il a une longueur de 4 et qu'il se déplace vers l'est.
On va donc procéder à l'initialisation des variables.<br>
	<textarea id="code" style="height:400px;">
		\ initialiation des variables.
		4 SCORE ! \ longueur initiale du serpent.
		2 METAB ! \ vitesse du métabolisme.
		SCORE SCALE * LIFE ! \ espérance de vie.
		EAST HEAD ! \ direction initial du serpent
		
		\ les coordonnées sont conservées dans un entier
		\ non signé. L'octet fort est la coordonnée y
		\ l'octet faible la coordonnée x.
		\ conversion entier vers coordonnées.
		: coord>xy  ( u -- x y )
		  256 /mod ;
		\ conversion coordonnées vers entier
		: xy>coord ( x y -- u )
		  256 * + ;
		\ ce mot va servir à copier la valeur de la queue 
		\ du serpent dans la variable TAIL.  
		: tail-set ( -- )
		   SCORE @ 1- SNAKE @ TAIL ! ;
		\ initialisation du serpent
		: snake-init  ( -- )
		  32 12 SCORE @ 0 do 2dup xy>coord i snake ! swap 1- swap loop 
		  tail-set ;
		\ lors de sa création une pastille ne doit pas
		\ être en collision avec le corps du serpent.
		: valid-food ( u -- f )
		    true swap
			SCORE @ 0 do i snake @ over = 
			if drop false swap leave then
			loop drop ; 
		\ création d'une pastille de nourriture
		: new-food ( -- )
		   repeat
		   rand abs PLAY-WIDTH MOD \ x
		   rand abs PLAY-HEIGHT MOD \ y 
		   xy>coord dup valid-food until
		   food ! ;
		 \ vérifie si le serpent se mord lui-même.
		 : snake-bit?  ( -- f )
		    false 0 snake @ score @ 1 do 
		    i snake  @ over = 
		    if drop true swap leave then loop
		    drop ;
		 \ vérfie si le serpent frappe le mur.
		 : collision? ( -- f )
			 0 snake @  coord>xy
			 
	</textarea>
</p>	
</body>
</html>
	
