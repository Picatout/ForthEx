<DOCTYPE! html>
<html lang="fr-CA">
<head>
 <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
 <link rel="stylesheet" type="text/css" href="css/forthex.css"></head>
<body id="#top">
<h1>flash</h1><div><a href="#index">index</a></div>
<div><a href="index.html#MasterIndex">index principal</a></div>
<h2 id="description">Description</h2><div>
</div>
<div>  Permet l'accès à des données stockées dans la mémoire flash du MCU.
</div>
<div>  Pour protéger le système l'écriture n'est autorisée qu'à partir de l'adresse 
</div>
<div>  0x8000. Une image de la mémoire RAM utilisateur peut-être sauvegardée dans la
</div>
<div>  mémoire flash du MCU avec le mot IMGSAVE.    
</div>
<div>  Cette image est automatiquement récupérée au démarrage du sytème. De plus si
</div>
<div>  cette image contient une définition appellée AUTORUN celle-ci sera exécutée au
</div>
<div>  au démarrage de l'ordinateur ou suite à une commande REBOOT. 
</div>
<div>  La taille d'une image étant limitée par la RAM utilistateur disponible à 27912 octets
</div>
<div>  le reste de la mémoire flash peut-être utilisée pour stocker des données.
</div>
<div>  Il n'y pas de risque d'endommager une image si on enregistre des données à partir
</div>
<div>  de l'adresse 0xF000 jusqu'à 0x557FE.    
</div>
<div>REF: <a href="
">
</a></div>
<div>  Pour plus d'information sur la programmation en runtime de la mémoire flash    
</div>
<div>  consultez les documents de référence Microchip: DS70609D et DS70000613D
</div>
<div>    
</div>
<div><a href="index.html#MasterIndex">index principal</a></div>
<hr style="border-width:4px;"><p id="FBUFFER">
<b>FBUFFER</b>  (  -- a-addr )
<div>   Réservation d'un bloc de mémoire dynamique pour écriture d'une rangée flash MCU.
</div>
<div>   Pour modifier une rangée on la lit dans ce tampon et lorsque les modifications sont
</div>
<div>   complétée, la rangée est effacée et reprogrammée avec le contenu de ce tampon. 
</div>
<div>   Ce bloc de mémoire dynamique peut-être libéré après usage en utilisant FREE il est
</div>
<div>   donc important de conserver une copie de son adresse. 
</div>
</p>
<div><b> arguments:
</b></div>
<div><i>aucun
</i>&nbsp;&nbsp;</div>
<div><b> retourne:
</b></div>
<div><i>a-addr</i>&nbsp;&nbsp;   Adresse du premier octet de donnée du tampon.
</div>
<div><a href="#index">index</a></div>
<div><a href="#top">haut</a></div>
<div><a href="index.html#MasterIndex">index principal</a></div>
<hr style="border-width:1px;"><p id="F@">
<b>F@</b>  (  ud1 -- u )    
<div>   Lecture d'un mot de 16 bits dans la mémoire FLASH.
</div>
<div>   Si ud1 est pair utilise l'instruction machine TBLRDL pour retourner les bits 15:0
</div>
<div>   Si ud1 est impair utilise l'instruction machine TBLRDH pour retourner les bits 32:16
</div>
<div>   les bit 32:24 sont à zéro puisque cet octet n'est pas implémenté dans le MCU.    
</div>
</p>
<div><b> arguments:
</b></div>
<div><i>ud1</i>&nbsp;&nbsp;  entier double, adresse dans la mémmoire flash du MCU.
</div>
<div><b> retourne:
</b></div>
<div><i>u</i>&nbsp;&nbsp;    Valeur lue à l'adresse ud1.
</div>
<div><a href="#index">index</a></div>
<div><a href="#top">haut</a></div>
<div><a href="index.html#MasterIndex">index principal</a></div>
<hr style="border-width:1px;"><p id="FC@L">
<b>FC@L</b> ( ud1 -- c )
<div>   Lecture d'un octet dans la partie basse de l'instruction. 
</div>
<div>   Utilise l'instruction machine TBLRDL.B    
</div>
<div>    Si ud1 est impair  les bits 15:8 sont retournés, sinon les bits 7:0 sont retournés.
</div>
</p>
<div><b> arguments:
</b></div>
<div><i>ud1</i>&nbsp;&nbsp;  Entier double, adresse en mémoire flash.
</div>
<div><b> retourne:
</b></div>
<div><i>c</i>&nbsp;&nbsp;    Si impair(ud1) c=bits{15:8}  sinon c=bits{7:0}
</div>
<div><a href="#index">index</a></div>
<div><a href="#top">haut</a></div>
<div><a href="index.html#MasterIndex">index principal</a></div>
<hr style="border-width:1px;"><p id="FC@H">
<b>FC@H</b>   ( ud1 -- c )    
<div>    Lecture d'un octet dans la mémoire flash du mot fort de l'instruction.
</div>
<div>    Utilise l'instruction machine TBLRDH.B
</div>
<div>    Si ud1 est impair retourne la valeur 0, sinon retourne les bits 23:16 de l'instruction.    
</div>
</p>
<div><b> arguments:
</b></div>
<div><i>ud1</i>&nbsp;&nbsp; Entier double, Adresse en mémoire flash.
</div>
<div><b> retourne:
</b></div>
<div><i>c</i>&nbsp;&nbsp; Valeur lue à l'adresse ud1.  c représente les bits 23..16 de l'instruction.
</div>
<div><a href="#index">index</a></div>
<div><a href="#top">haut</a></div>
<div><a href="index.html#MasterIndex">index principal</a></div>
<hr style="border-width:1px;"><p id="I@">
<b>I@</b>   ( ud -- u1 u2 u3 )    
<div>   Lit 1 instruction de la mémoire FLASH du MCU. L'instrucion est séparée en
</div>
<div>   3 octets. Accès à la mémoire flash en utilisant les instructions machine TBLRDL et TBLRDH .
</div>
</p>
<div><b> arguments:    
</b></div>
<div><i>ud</i>&nbsp;&nbsp;  Entier double, adresse en  mémoire flash.
</div>
<div><b> retourne:
</b></div>
<div><i>u1</i>&nbsp;&nbsp;  Bits 16:23 
</div>
<div><i>u2</i>&nbsp;&nbsp;  Bits 8:15
</div>
<div><i>u3</i>&nbsp;&nbsp;  Bits 0:7    
</div>
<div><a href="#index">index</a></div>
<div><a href="#top">haut</a></div>
<div><a href="index.html#MasterIndex">index principal</a></div>
<hr style="border-width:1px;"><p id="IC@">
<b>IC@</b> ( ud u -- c )
<div>   Lit 1 octet dans la mémoire flash à l'adresse d'instruction 'ud' et à la position
</div>
<div>   désignée par 'u'. 'u' est dans l'intervalle {0..2}
</div>
<div>   0 retourne l'octet faible, bits 7:0
</div>
<div>   1 retourne l'octet du milieu, bits 15:8
</div>
<div>   2 retourne l'octet fort, bits 23:16
</div>
</p>
<div><b> arguments:
</b></div>
<div><i>ud</i>&nbsp;&nbsp;   Entier double, adresse de l'instruction. ud doit-être un nombre pair.
</div>
<div><i>u</i>&nbsp;&nbsp;    Entier dans l'intervalle {0..2} indiquant quel octet de l'instruction doit-être lu.
</div>
<div><b> retourne:
</b></div>
<div><i>c</i>&nbsp;&nbsp;    Octet lu dans la mémoire flash.
</div>
<div><a href="#index">index</a></div>
<div><a href="#top">haut</a></div>
<div><a href="index.html#MasterIndex">index principal</a></div>
<hr style="border-width:1px;"><p id="?FLIMITS">
<b>?FLIMITS</b>   ( ud -- ud f )    
<div>   Vérifie si l'adresse 24 bits représsentée par 'ud' est dans la plage
</div>
<div>   valide et retourne un indicateur booléen.
</div>
</p>
<div><b> arguments:
</b></div>
<div><i>ud</i>&nbsp;&nbsp;   Adresse 24 bits à contrôler.
</div>
<div><b> retourne:
</b></div>
<div><i>ud</i>&nbsp;&nbsp;   Adresse contrôlée.
</div>
<div><i>f</i>&nbsp;&nbsp;    Indicateur Booléen, faux si cette adresse n'est pas valide.    
</div>
<div><a href="#index">index</a></div>
<div><a href="#top">haut</a></div>
<div><a href="index.html#MasterIndex">index principal</a></div>
<hr style="border-width:1px;"><p id="ROW&gt;FADR">
<b>ROW&gt;FADR</b>  ( u -- ud )
<div>   Convertie un numéro de rangée en adresse FLASH 24 bits.
</div>
<div>   La plus petite plage de mémoire flash qui peut-être effacée est appellée rangée ou page.    
</div>
<div>   Pour le PIC24EP512GP202 une rangée représente 1024 instructions machine
</div>
<div>   soit 2048 adresses PC ou 3072 octets.
</div>
<div>   donc ud=2048*u    
</div>
</p>
<div><b> arguments:
</b></div>
<div><i>u</i>&nbsp;&nbsp;    Numéro de rangée.
</div>
<div><b> retourne:
</b></div>
<div><i>ud</i>&nbsp;&nbsp;   Entier double, adresse 24 bits de la rangée.    
</div>
<div><a href="#index">index</a></div>
<div><a href="#top">haut</a></div>
<div><a href="index.html#MasterIndex">index principal</a></div>
<hr style="border-width:1px;"><p id="FERASE">
<b>FERASE</b>   ( u -- )    
<div>   Efface une rangée de mémoire FLASH MCU
</div>
<div>   Une rangée correspond à 1024 instructions.
</div>
<div>   Les instructions étant codées sur 24 bits, 1 rangée correspond à 3072 octets.
</div>
<div>   Le compteur d'instruction du MCU incrémente par 2 et pointe toujours sur une adresse paire. 
</div>
<div>   Voir ROW&gt;FADR    
</div>
</p>
<div><b> arguments:      
</b></div>
<div><i>u</i>&nbsp;&nbsp;  numéro de la rangée.
</div>
<div><b> retourne:
</b></div>
<div><i>rien
</i>&nbsp;&nbsp;</div>
<div><a href="#index">index</a></div>
<div><a href="#top">haut</a></div>
<div><a href="index.html#MasterIndex">index principal</a></div>
<hr style="border-width:1px;"><p id="RAM&gt;FLASH">
<b>RAM&gt;FLASH</b>  ( c-addr n ud -- )    
<div>   Écris en mémoire flash un bloc de données en RAM.
</div>
<div>   Si n n'est pas un  multiple de 6, jusqu'à 5 octets au delà du tampon seront copiés en FLASH. 
</div>
<div>   Au besoin remplir les octets excédentaires avec la valeur 0xFF.    
</div>
</p>
<div><b> arguments:    
</b></div>
<div><i>c-addr</i>&nbsp;&nbsp;  Adresse début données en RAM.
</div>
<div><i>n</i>&nbsp;&nbsp;     Nombre d'octets à écrire.
</div>
<div><i>ud</i>&nbsp;&nbsp;    Entier double, addresse 24 bits en mémoire FLASH.
</div>
<div><b> retourne:
</b></div>
<div><i>rien</i>&nbsp;&nbsp;    
</div>
<div><a href="#index">index</a></div>
<div><a href="#top">haut</a></div>
<div><a href="index.html#MasterIndex">index principal</a></div>
<hr style="border-width:1px;"><p id="FLASH&gt;RAM">
<b>FLASH&gt;RAM</b>  ( c-addr n ud -- )  
<div>  Lecture d'un bloc FLASH dans un tampon en mémoire RAM.
</div>
</p>
<div><b> arguments:  
</b></div>
<div><i>c-addr</i>&nbsp;&nbsp;  Adresse 16 bits début RAM.
</div>
<div><i>n</i>&nbsp;&nbsp;     Nombre d'octets à lire.
</div>
<div><i>ud</i>&nbsp;&nbsp;    Entier double, adresse début plage FLASH.
</div>
<div><b> retourne:
</b></div>
<div><i>rien</i>&nbsp;&nbsp;  
</div>
<div><a href="#index">index</a></div>
<div><a href="#top">haut</a></div>
<div><a href="index.html#MasterIndex">index principal</a></div>
<hr style="border-width:1px;"><p id="?IMG">
<b>?IMG</b>  ( -- f )    
<div>   Vérifie s'il y a une image disponible en mémoire flash et retourne 
</div>
<div>   un indicateur Booléen vrai|faux.
</div>
</p>
<div><b> arguments:
</b></div>
<div><i>aucun</i>&nbsp;&nbsp;    
</div>
<div><b> retourne:
</b></div>
<div><i>f</i>&nbsp;&nbsp;  Indicateur booléen vrai|faux
</div>
<div><a href="#index">index</a></div>
<div><a href="#top">haut</a></div>
<div><a href="index.html#MasterIndex">index principal</a></div>
<hr style="border-width:1px;"><p id="IMGSAVE">
<b>IMGSAVE</b>   ( -- )    
<div>   Sauvegarde une image de la RAM dans la mémoire flash du MCU.
</div>
<div>   Les données à partir de l'adresse DP0 jusqu'à l'adresse DP-1 sont
</div>
<div>   sauvegardées dans cette image, ainsi que les valeurs des variables
</div>
<div>   systèmes LATEST et DP.
</div>
<div>   Si le MCU est reprogrammé l'image est perdue et devra être resauvegardée.    
</div>
<div>   l'image est sauvegardée à l'adresse flash 0x8000. Les 8 premiers octets sont
</div>
<div>   une structure de données utilisé par IMGLOAD. Cette structure est la suivante.
</div>
<div>  <br><table border="single">    
</div>
<div>  <tr><th>offset</th><th>description</th></tr>
</div>
<div>  <tr><td><center>0</center></td><td>signature 0x55AA</td></tr>
</div>
<div>  <tr><td><center>2</center></td><td>valeur de la variable LATEST pour cette image.</td></tr>
</div>
<div>  <tr><td><center>4</center></td><td>valeur de la variable DP pour cette image.</td></tr>
</div>
<div>  <tr><td><center>6</center></td><td>grandeur du data en octets.</td></tr>
</div>
<div>  </table><br>    
</div>
</p>
<div><b> arguments:
</b></div>
<div><i>aucun
</i>&nbsp;&nbsp;</div>
<div><b> retourne:
</b></div>
<div><i>rien</i>&nbsp;&nbsp;    
</div>
<div><a href="#index">index</a></div>
<div><a href="#top">haut</a></div>
<div><a href="index.html#MasterIndex">index principal</a></div>
<hr style="border-width:1px;"><p id="IMGLOAD">
<b>IMGLOAD</b>  ( -- )  
<div>    Charge une image système RAM à partir de la mémoire flash du MCU.
</div>
<div>    Au démarrage de l'ordinateur IMGLOAD est appellé et s'il y a une image
</div>
<div>    système en mémoire flash celle-ci est chargée en mémoire RAM.
</div>
<div>    S'il n'y a pas d'image disponible le message "No boot image available."
</div>
<div>    est affiché à l'écran.
</div>
<div>    Si l'image chargée en RAM contient une définition AUTORUN dans son dictionnaire
</div>
<div>    ce mot est exécuté.
</div>
<div>    IMGLOAD peut-être appellé manuellement pour restaurer l'état système à l'état
</div>
<div>    initial au démarrage, dans ce cas AUTORUN n'est pas exécuté.  
</div>
</p>
<div><b> arguments:
</b></div>
<div><i>aucun
</i>&nbsp;&nbsp;</div>
<div><b> retourne:
</b></div>
<div><i>rien</i>&nbsp;&nbsp;  
</div>
<div><a href="#index">index</a></div>
<div><a href="#top">haut</a></div>
<div><a href="index.html#MasterIndex">index principal</a></div>
<hr style="border-width:1px;"><h4 id="index">Index</h4>
<p>
<ul>
<li><a href="#?FLIMITS">?FLIMITS</a></li>
<li><a href="#?IMG">?IMG</a></li>
<li><a href="#F@">F@</a></li>
<li><a href="#FBUFFER">FBUFFER</a></li>
<li><a href="#FC@H">FC@H</a></li>
<li><a href="#FC@L">FC@L</a></li>
<li><a href="#FERASE">FERASE</a></li>
<li><a href="#FLASH&gt;RAM">FLASH&gt;RAM</a></li>
<li><a href="#I@">I@</a></li>
<li><a href="#IC@">IC@</a></li>
<li><a href="#IMGLOAD">IMGLOAD</a></li>
<li><a href="#IMGSAVE">IMGSAVE</a></li>
<li><a href="#RAM&gt;FLASH">RAM&gt;FLASH</a></li>
<li><a href="#ROW&gt;FADR">ROW&gt;FADR</a></li>
</ul>
</p>
<hr style="border-width:1px;"><div><a href="#top">haut</a></div>
<div><a href="index.html#MasterIndex">index principal</a></div>

</body>
</html>
